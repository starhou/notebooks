# 存储与索引

&ensp;&ensp;&ensp;DBMS数据要保持持久性，需要存储在磁盘上。磁盘读写信息的单位是**页**，页的大小是DBMS的一个参数，典型值是4KB和8KB。

* 按照页面存储的物理顺序读取数据比随机顺序读取数据要快的多
* 磁带是顺序访问设备
* 文件的每个记录都有一个标示符，rid。

## 索引
&ensp;&ensp;&ensp;**索引**是在磁盘上组织数据记录的一种数据结构。**数据项**是指存储在索引文件中的记录。

&ensp;&ensp;&ensp;三种不同方式存储数据。搜索码$k$中的数据记为$k*$。

* 数据项$k*$是真正的数据记录
* $<k, rid>$
* $<k, [rid_0,rid_1...rid_k]>$

**聚簇索引**: 其数据项和实际的物理数据据记录一致或相似；不一致称为**非聚簇索引**。

### 基于哈希的索引

&ensp;&ensp;&ensp;如果巧妙地调整插入和删除，基于哈希的索引结构可以经过1~2 I/O检索到包含数据的页。索引的搜索码可以是一个或多个字段的序列，它不必唯一地确定记录。

### 基于树的索引
&ensp;&ensp;&ensp;树的最下层，即叶子层，包含数据项。搜索中出现的磁盘I/O数就等于从根节点到叶节点的路径长加上满足条件的数据项的叶子页个数。B+树是一种保证根到叶子路径等长的索引结构，即，这种结构高度平衡。检索一个想要的叶子页，一般不超过4次I/O，由于根一般在缓冲区，所以一般3次I/O就够了。
&ensp;&ensp;&ensp;非叶子节点的平均孩子数称为树的**扇出**，如果一个非叶子节点的孩子为n, 则可以存储$n^h$个叶子页。
#### 不同文件组织的比较

1. 堆文件，任意排序
2. 排序文件
3. 搜索码为聚簇B+树
4. 非聚簇B+树索引堆文件
5. 非聚簇哈希索引堆文件

|文件类型|扫描|等值搜索|范围搜索|插入|删除|
|:---:|:----:|:----:|:----:|:------:|:------:|
|堆  | BD |0.5BD|BD|2D|Search+D|
|排序索引  | BD |$Dlog_2B$|D$log_2B$+ # matching pages|Search+BD|Search+BD|
|聚簇树索引  | 1.5BD |$Dlog_F1.5B$|$Dlog_F1.5B$+ # matching pages|Search+D|Search+D|
|非聚簇树索引  | BD(R+0.15) |$D(1+log_F1.5B)$|$D(1+log_F1.5B)$+ # matching pages|D(3+$D(1+log_F1.5B)$)|Search+2D|
|非聚簇哈希索引 | BD(R+0.125) |2D|BD|4D|Search+2D|

**堆**文件存的快，支持快速扫描和插入，但是搜索和删除慢。

**排序文件**文件存的快，插入和删除比较慢。搜索比堆块。一般DBMS不使用。

**聚簇树文件**存的较快，且插入和删除较快。（空间换时间）。搜索比排序还快。

**非聚簇树和哈希文件** 搜索、插入和删除都比较快，但扫描和有较多匹配结果的范围搜索比较慢。等值搜索，哈希快，但范围搜索需扫描。


#### 代价模型
&ensp;&ensp;&ensp;**B**表示当页中无浪费空间时数据页的数量，用**R**表示每一页的记录数。读写一个磁盘页的平均时间是**D**，处理一个记录平均时间是**C**，将哈希函数应用于一个及记录时间是**H**,**F**表示扇出。

&ensp;&ensp;&ensp;典型值： **F**：100， **D**：15ms， **C**和**H**为100ns; 其中I/O占整个代价的主导地位。


#### 索引和性能调整
&ensp;&ensp;&ensp;树索引用的最广泛，其优点如下，

+ 可有效处理数据项中的插入和删除
+ 当通过搜搜码的值来找正确的叶子页时候，树结构的的查找速度要比二分法查找要快的多。

缺点如下

&ensp;&ensp;&ensp;排序文件的页在磁盘上可以按照物理顺序分配，使得检索若干连续的页十分快。但在排序的文件中完成插入和删除的代价十分大。


###### 聚簇索引组织

&ensp;&ensp;&ensp;一般一个数据记录集合只有一个聚簇索引。

###### 复合搜索码
&ensp;&ensp;&ensp;索引的搜索码可以包含若干字段：每一个码都被称为符合搜索码或链接码。

选择复合码的折中考虑

一个复合码可以支持更广范围的查询。任何修改了搜索码中任何字段的操作（插入、删除和更新）都要导致复合索引的更新。因为数据项所占空间较大，所以复合索引比单索引所占空间更大。对于复合B+树来说，这可能意味着增加层数。



